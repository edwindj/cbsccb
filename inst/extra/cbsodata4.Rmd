---
output: 
  rmarkdown::github_document:
    df_print: kable
vignette: >
  %\VignetteIndexEntry{cbsodata4}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

[Statistics Netherlands (CBS)](https://www.cbs.nl) is the office that
produces all official statistics of the Netherlands.

For long SN has put its data on the web in its online database
[StatLine](https://opendata.cbs.nl/statline#/CBS/en/). Since 2014 this
data base has an open data web API based on the OData protocol and other
The [cbsodataR](https://CRAN.R-project.org/package=cbsodataR ) package allows 
for retrieving data right into R using this API.

A new version of the web api has been developed which is based on the OData4 
protocol. This OData4 API contains major changes in how the metadata and data
is transported, hence this package `cbsodata4`. Since the old web api will be
phased out in due time, `cbsodata4` is the successor of `cbsodataR`.

This document describes how to use `cbsodata4` to download data (and meta data) 
from Statistics Netherlands. It offers very similar functions as `cbsodataR`,
so should be familiar to users of `cbsodataR`, but there are differences so 
check carefully your code.


```{r setup}
library(cbsodata4)
```

## List of datasets (toc)

A list of datasets that are available can be loaded with with `cbs4_get_datasets()` (`cbs4_get_toc()` is an alias)

```{r}
datasets <- cbs4_get_datasets()
head(datasets[,c("Identifier", "Title", "Modified")])
```

Using an “Identifier” from `cbs4_get_datasets` information on the table can be
retrieved with `cbs4_get_metadata`

```{r}
meta_petrol <- cbs4_get_metadata("80416ned")
meta_petrol
```

The meta object contains all metadata properties of cbsodata
in the form of data.frames. Each data.frame describes properties of the
SN table: "Dimensions", "MeasureCodes" and one ore more "<Dimension>Codes" describing the meta data of the borders
of a SN table.

```{r}
names(meta_petrol)
head(meta_petrol$PeriodenCodes)
```

## Data download

With `cbs4_get_observations` and `cbs4_get_data` data can be retrieved. By 
default this default will be downloaed in a temporary directory.

`cbs4_get_observations` is the format in which the data is downloaded from SN. 
It is in so-called long format. It contains
one `Measure` column, describing the topics/variable, one `Value` column 
describing the statistical value, one or more Dimension columns and some extra
columns with value specific metadata.

```{r}
obs <- cbs4_get_observations("80416ned")
head(obs)
```

`cbs4_get_data` returns the data in so-called wide format in which each `Measure` has its own column. For many
uses this is a more natural format. It is a pivoted version of `cbs4_get_observations()`.

```{r}
# same 
data <- cbs4_get_data("80416ned")
head(data)
```

### adding category label columns

The Dimension and Measure columns use codes/keys/identifiers to describe categories. These can be found in the metadata, but can also be automatically added using `cbs4_add_label_columns`.

```{r}
obs <- cbs4_get_observations("80416ned")
obs <- cbs4_add_label_columns(obs)
head(obs)
```

or

```{r}
data <- cbs4_get_data("80416ned")
data <- cbs4_add_label_columns(data)
head(data)
```

### Adding Date column

The period/time columns of Statistics Netherlands (CBS) contain coded
time periods: e.g. 2018JJ00 (i.e. 2018), 2018KW03 (i.e. 2018 Q3),
2016MM04 (i.e. 2016 April). With `cbs4_add_date_column` the time periods
will be converted and added to the data:


```{r}
obs <- cbs4_get_observations("80416ned")
obs <- cbs4_add_date_column(obs)
head(obs)

data <- cbs4_get_data("80416ned")
data <- cbs4_add_date_column(data)
head(data)
```

### Adding a Unit column

Each `Measure` has a measure unit, which
can be added to observations with `cbs4_add_unit_column()` 

```{r}
obs <- cbs4_get_observations("80416ned")
obs <- cbs4_add_unit_column(obs)
head(obs)
```

## Select and filter

It is possible restrict the download using filter statements. This may shorten the download time considerably.

### Filter

Filter statements for the columns can be used to restrict the download. 
Note the following:

- To filter you will need to use the values found in the `Identifier` column in
the `cbs4_get_metadata` objects. e.g. for year 2020, the code is "2020JJ00".

```{r}
meta <- cbs4_get_metadata("60006")
tail(meta$PeriodenCodes)
```

obs <- cbs4_get_observations("60006")

- To filter for values in a column add `<column_name> = values` to 
`cbs4_get_observations` (or `cbs4_get_data`)  e.g. `Perioden = c("2020JJ00", "2020JJ0")`


```{r, get_data3, message=FALSE}
obs <- cbs4_get_observations("60006", Perioden = c("2019JJ00", "2020JJ0"))
cbs4_add_label_columns(obs)
```

- To filter for values in a column that have a substring e.g. "JJ" you can 
use `<column_name> = contains(<substring>)` to `cbs4_get_data` e.g. 
`Perioden = contains("JJ")`

```{r}
data <- cbs4_get_data("60006", Perioden = contains("2019"))
data
```

- To combine values and substring use the "|" operator: `Periods = contains("2019") | "2020KW01"

```{r}
data <- cbs4_get_data("60006", Perioden = contains("2019") | "2020KW01")
data
```

# Download data

Data can also be downloaded explicitly by using `cbs4_download_table`



```{r}
catalogs <- cbs4_get_catalogs() 
catalogs[,1:2]
```

